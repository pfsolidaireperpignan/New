<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PF FINANCE - Facturation</title>
    
    <link rel="stylesheet" href="style.css">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>
    <img id="logo-source" src="Logo.png" style="display: none;" crossorigin="anonymous">
    
    <datalist id="clients_suggestions"></datalist>
    <datalist id="defunts_suggestions"></datalist>
    <datalist id="fournisseurs_list">
        <option value="URSSAF">
        <option value="EDF">
        <option value="ORANGE">
        <option value="IMPOTS">
        <option value="CARBURANT">
    </datalist>

    <div id="modal-choix" class="modal hidden" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9000; display:flex; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:12px; text-align:center; width:300px;">
            <h3 style="margin-top:0;">Nouveau Document</h3>
            <div style="display:grid; gap:10px; margin-top:20px;">
                <button onclick="window.creerNouveau('DEVIS')" class="btn btn-primary" style="justify-content:center;">Créer un DEVIS</button>
                <button onclick="window.creerNouveau('FACTURE')" class="btn btn-primary" style="justify-content:center; background:var(--dark);">Créer une FACTURE</button>
                <button onclick="document.getElementById('modal-choix').classList.add('hidden')" class="btn btn-danger" style="justify-content:center; margin-top:10px;">Annuler</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-dove"></i>
            <span class="brand-text">PF ERP</span>
        </div>
        <nav>
            <a href="index.html" class="nav-link">
                <i class="fas fa-home"></i>
                <span class="nav-text">Accueil</span>
            </a>
            <a href="facturation_v2.html" class="nav-link active">
                <i class="fas fa-file-invoice-dollar"></i>
                <span class="nav-text">Facturation</span>
            </a>
            <a href="dossier_complet.html" class="nav-link">
                <i class="fas fa-folder-open"></i>
                <span class="nav-text">Atelier Dossier</span>
            </a>
        </nav>
        <button id="btn-toggle-menu" onclick="window.toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <div class="main-content">
        
        <div class="page-header">
            <div>
                <h2 style="margin:0;">Pilotage Financier</h2>
                <div style="color:var(--gray); font-size:0.9rem;">Gérez vos devis, factures et dépenses</div>
            </div>
            
            <div class="btn-tab-container">
                <button id="btn-tab-factures" class="btn-tab active" onclick="window.switchTab('factures')">
                    <i class="fas fa-file-invoice"></i> VENTES
                </button>
                <button id="btn-tab-achats" class="btn-tab" onclick="window.switchTab('achats')">
                    <i class="fas fa-shopping-basket"></i> ACHATS
                </button>
            </div>
        </div>

        <div id="tab-factures">
            
            <div id="liste-factures-container">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <div style="position:relative;">
                        <input type="text" id="search_facture" onkeyup="window.filtrerHistorique()" placeholder="Rechercher un client..." style="padding-left:35px; width:300px;">
                        <i class="fas fa-search" style="position:absolute; left:12px; top:12px; color:var(--gray);"></i>
                    </div>
                    <button class="btn btn-primary" onclick="document.getElementById('modal-choix').classList.remove('hidden')">
                        <i class="fas fa-plus"></i> NOUVEAU
                    </button>
                </div>

                <div class="card" style="padding:0; overflow:hidden;">
                    <table class="table">
                        <thead style="background:#f8fafc;">
                            <tr>
                                <th>Date</th>
                                <th>Numéro</th>
                                <th>Client / Défunt</th>
                                <th>Montant</th>
                                <th>État</th>
                                <th style="text-align:right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="editeur-facture" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <button onclick="window.fermerEditeur()" class="btn btn-danger"><i class="fas fa-arrow-left"></i> RETOUR LISTE</button>
                    <div>
                        <button onclick="window.genererPDFFacture()" class="btn" style="background:var(--purple); color:white; margin-right:10px;"><i class="fas fa-print"></i> IMPRIMER</button>
                        <button id="btn-save-facture" onclick="window.sauvegarderFactureBase()" class="btn btn-primary"><i class="fas fa-save"></i> ENREGISTRER</button>
                    </div>
                </div>

                <div class="card" id="facture-preview">
                    <div style="display:flex; justify-content:space-between; border-bottom:2px solid #eee; padding-bottom:20px; margin-bottom:20px;">
                        <div>
                            <img src="Logo.png" style="height:80px; margin-bottom:10px;">
                            <div style="font-size:0.9rem; color:#666;">
                                32 Bd Léon Jean Grégory, Thuir<br>
                                Tél: 04 68 53 10 10<br>
                                Siret: 539 270 298 00034
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <h2 id="doc_type_title" style="color:var(--primary); margin:0;">FACTURE</h2>
                            <div style="font-size:1.2rem; font-weight:bold; margin:5px 0;" id="doc_num">F-2024-000</div>
                            <input type="date" id="facture_date" style="text-align:right; border:none; font-family:inherit;">
                        </div>
                    </div>

                    <div class="grid-2" style="margin-bottom:30px;">
                        <div style="background:#f8fafc; padding:15px; border-radius:8px;">
                            <h4 style="margin-top:0; color:var(--primary);"><i class="fas fa-user"></i> CLIENT (Payeur)</h4>
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <select id="client_civility" style="width:80px; font-weight:bold;"><option>M.</option><option>Mme</option></select>
                                <input id="client_nom" list="clients_suggestions" placeholder="Nom Prénom" onchange="window.checkClientAuto()" style="flex:1;">
                            </div>
                            <input id="client_adresse" placeholder="Adresse complète" style="margin-bottom:10px;">
                            <input id="client_cp" placeholder="Code Postal" style="width:100px; margin-right:10px;">
                            <input id="client_ville" placeholder="Ville" style="width:calc(100% - 115px);">
                        </div>
                        <div style="background:#f8fafc; padding:15px; border-radius:8px;">
                            <h4 style="margin-top:0; color:var(--dark);"><i class="fas fa-cross"></i> CONCERNE (Défunt)</h4>
                            
                            <div style="display:flex; gap:10px; margin-bottom:10px;">
                                <select id="defunt_civility" style="width:80px; font-weight:bold;"><option>M.</option><option>Mme</option></select>
                                <input id="defunt_nom" list="defunts_suggestions" placeholder="Nom Prénom du Défunt" style="flex:1;">
                            </div>
                            
                            <input type="date" id="defunt_date_deces" title="Date de décès">
                            <input id="defunt_ville_deces" placeholder="Lieu de décès" style="margin-top:10px;">
                        </div>
                    </div>

                    <table class="table" style="margin-bottom:20px;">
                        <thead style="background:var(--primary); color:white;">
                            <tr>
                                <th style="color:white; width:50px;"></th>
                                <th style="color:white;">Désignation</th>
                                <th style="color:white; width:100px;">Prix TTC</th>
                                <th style="color:white; width:50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="lignes_facture">
                            </tbody>
                    </table>

                    <div style="text-align:center; margin-bottom:20px; padding:15px; border:2px dashed #ddd; border-radius:8px; color:#666;">
                        <p style="margin-bottom:10px;">Ajouter une ligne rapide :</p>
                        <button onclick="window.ajouterTitreSection()" class="btn" style="background:#eee; color:#333; margin-right:5px;"><i class="fas fa-heading"></i> Titre</button>
                        <button onclick="window.ajouterLigne()" class="btn" style="background:#eee; color:#333;"><i class="fas fa-plus"></i> Article</button>
                        <div style="margin-top:10px;">
                            <small>Modèles : </small>
                            <button onclick="window.loadTemplate('Inhumation')" style="border:none; background:none; color:var(--secondary); cursor:pointer; text-decoration:underline;">Inhumation</button> | 
                            <button onclick="window.loadTemplate('Cremation')" style="border:none; background:none; color:var(--secondary); cursor:pointer; text-decoration:underline;">Crémation</button>
                        </div>
                    </div>

                    <div style="display:flex; justify-content:flex-end;">
                        <div style="width:250px; background:#f8fafc; padding:20px; border-radius:8px;">
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                <span>Total HT</span>
                                <span id="total_ht">0.00 €</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-bottom:10px; color:#666;">
                                <span>TVA (20%)</span>
                                <span id="total_tva">0.00 €</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:bold; color:var(--primary); border-top:2px solid #ddd; padding-top:10px;">
                                <span>NET À PAYER</span>
                                <span id="total_ttc">0.00 €</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-achats" class="hidden">
            
            <div class="grid-3">
                <div class="card" style="border-left:4px solid var(--danger);">
                    <div style="color:var(--gray); font-size:0.8rem;">Dépenses du Mois</div>
                    <div style="font-size:1.5rem; font-weight:800; color:var(--danger);" id="stat-depenses">0.00 €</div>
                </div>
                </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn btn-danger" onclick="window.toggleNewExpenseForm()">
                    <i class="fas fa-plus-circle"></i> NOUVELLE DÉPENSE
                </button>
                <div style="background:white; padding:5px 15px; border-radius:50px; border:1px solid #ddd; font-weight:bold;">
                    TOTAL FILTRÉ : <span id="total-filtre-display">0.00 €</span>
                </div>
            </div>

            <div id="container-form-depense" class="toggle-form-container card" style="background:#fff1f2; border:1px solid #fecaca;">
                <h3 style="margin-top:0; color:#991b1b;"><i class="fas fa-receipt"></i> Saisie Dépense</h3>
                <form id="form-depense" onsubmit="event.preventDefault(); window.gererDepense();">
                    <input type="hidden" id="dep_edit_id">
                    
                    <div class="grid-4">
                        <div><label>Date Facture</label><input type="date" id="dep_date_fac" required></div>
                        <div><label>Fournisseur</label><input list="fournisseurs_list" id="dep_fourn" placeholder="Ex: EDF..." required></div>
                        <div><label>N° Pièce</label><input type="text" id="dep_ref" placeholder="F-2024-..."></div>
                        
                        <div><label>Montant TTC</label><input type="number" id="dep_montant" placeholder="0.00" step="0.01" required></div>
                    </div>

                    <div class="grid-2" style="margin-top:15px;">
                        <div><label>Catégorie</label>
                            <select id="dep_cat">
                                <option>Achat Marchandises (Cercueils...)</option>
                                <option>Sous-traitance (Marbrerie...)</option>
                                <option>Frais Généraux (Loyer, EDF...)</option>
                                <option>Carburant / Véhicules</option>
                                <option>Salaires / Charges</option>
                                <option>Impôts et Taxes</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        <div><label>Détails (Optionnel)</label><input type="text" id="dep_details" placeholder="Note interne..."></div>
                    </div>

                    <div class="grid-3" style="margin-top:15px; padding-top:15px; border-top:1px dashed #fecaca;">
                        <div><label>Statut Paiement</label>
                            <select id="dep_statut">
                                <option value="Réglé">Réglé (Payé)</option>
                                <option value="À payer">À payer (Dette)</option>
                            </select>
                        </div>
                        <div><label>Mode de Règlement</label>
                            <select id="dep_mode">
                                <option value="Virement">Virement</option>
                                <option value="Carte Bancaire">Carte Bancaire</option>
                                <option value="Prélèvement">Prélèvement</option>
                                <option value="Chèque">Chèque</option>
                                <option value="Espèces">Espèces</option>
                            </select>
                        </div>
                        <div><label>Date de Règlement</label><input type="date" id="dep_date_reg"></div>
                    </div>

                    <div style="text-align:right; margin-top:20px;">
                        <button type="button" onclick="window.toggleNewExpenseForm()" class="btn" style="background:transparent; color:#991b1b;">Annuler</button>
                        <button type="submit" id="btn-action-depense" class="btn btn-danger"><i class="fas fa-check"></i> ENREGISTRER</button>
                    </div>
                </form>
            </div>

            <div class="card" style="padding:15px; background:#f9fafb; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <i class="fas fa-filter" style="color:var(--gray);"></i>
                <input type="text" id="search_depense" onkeyup="window.filtrerDepenses()" placeholder="Rechercher..." style="padding:8px; width:200px;">
                <input type="date" id="filter_date_start" onchange="window.filtrerDepenses()" style="padding:8px; width:130px;">
                <input type="date" id="filter_date_end" onchange="window.filtrerDepenses()" style="padding:8px; width:130px;">
                <select id="filter_cat" onchange="window.filtrerDepenses()" style="padding:8px; width:150px;"><option value="">Toutes Cat.</option><option>Achat Marchandises</option><option>Frais Généraux</option></select>
                <select id="filter_statut" onchange="window.filtrerDepenses()" style="padding:8px; width:120px;"><option value="">Tout Statut</option><option value="À payer">À payer</option><option value="Réglé">Réglé</option></select>
                <button onclick="window.exportCsvAchats()" class="btn-icon" title="Exporter CSV" style="margin-left:auto;"><i class="fas fa-file-csv" style="color:green;"></i></button>
            </div>

            <div class="card" style="padding:0; overflow:hidden;">
                <table class="table">
                    <thead style="background:#fef2f2;">
                        <tr>
                            <th>DATES</th>
                            <th>FOURNISSEUR</th>
                            <th>DÉTAILS</th>
                            <th style="text-align:center;">RÈGLEMENT</th>
                            <th style="text-align:center;">STATUT</th>
                            <th style="text-align:right;">MONTANT</th>
                            <th style="text-align:center;">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="depenses-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module" src="js/facturation.js"></script>
    
    <script>
        window.toggleSidebar = function() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) sidebar.classList.toggle('collapsed');
        };
    </script>
</body>
</html>
